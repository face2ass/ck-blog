<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script src="./d3.v7.min.js"></script>
    <script>

      const data = {
        'name': 'flare',
        'children': [
          {
            'name': 'analytics',
            'children': [
              {
                'name': 'cluster',
                'children': [
                  { 'name': 'AgglomerativeCluster', 'value': 3938 },
                  { 'name': 'CommunityStructure', 'value': 3812 },
                  { 'name': 'HierarchicalCluster', 'value': 6714 },
                  { 'name': 'MergeEdge', 'value': 743 }
                ]
              },
              {
                'name': 'graph',
                'children': [
                  { 'name': 'BetweennessCentrality', 'value': 3534 },
                  { 'name': 'LinkDistance', 'value': 5731 },
                  { 'name': 'MaxFlowMinCut', 'value': 7840 },
                  { 'name': 'ShortestPaths', 'value': 5914 },
                  { 'name': 'SpanningTree', 'value': 3416 }
                ]
              },
              {
                'name': 'optimization',
                'children': [
                  { 'name': 'AspectRatioBanker', 'value': 7074 }
                ]
              }
            ]
          },
          {
            'name': 'data',
            'children': [
              {
                'name': 'converters',
                'children': [
                  { 'name': 'Converters', 'value': 721 },
                  { 'name': 'DelimitedTextConverter', 'value': 4294 },
                  { 'name': 'GraphMLConverter', 'value': 9800 },
                  { 'name': 'IDataConverter', 'value': 1314 },
                  { 'name': 'JSONConverter', 'value': 2220 }
                ]
              },
              { 'name': 'DataField', 'value': 1759 },
              { 'name': 'DataSchema', 'value': 2165 },
              { 'name': 'DataSet', 'value': 586 },
              { 'name': 'DataSource', 'value': 3331 },
              { 'name': 'DataTable', 'value': 772 },
              { 'name': 'DataUtil', 'value': 3322 }
            ]
          },
          {
            'name': 'vis',
            'children': [
              {
                'name': 'axis',
                'children': [
                  { 'name': 'Axes', 'value': 1302 },
                  { 'name': 'Axis', 'value': 24593 },
                  { 'name': 'AxisGridLine', 'value': 652 },
                  { 'name': 'AxisLabel', 'value': 636 },
                  { 'name': 'CartesianAxes', 'value': 6703 }
                ]
              },
              {
                'name': 'controls',
                'children': [
                  { 'name': 'AnchorControl', 'value': 2138 },
                  { 'name': 'ClickControl', 'value': 3824 },
                  { 'name': 'Control', 'value': 1353 },
                  { 'name': 'ControlList', 'value': 4665 },
                  { 'name': 'DragControl', 'value': 2649 },
                  { 'name': 'ExpandControl', 'value': 2832 },
                  { 'name': 'HoverControl', 'value': 4896 },
                  { 'name': 'IControl', 'value': 763 },
                  { 'name': 'PanZoomControl', 'value': 5222 },
                  { 'name': 'SelectionControl', 'value': 7862 },
                  { 'name': 'TooltipControl', 'value': 8435 }
                ]
              },
              {
                'name': 'data',
                'children': [
                  { 'name': 'Data', 'value': 20544 },
                  { 'name': 'DataList', 'value': 19788 },
                  { 'name': 'DataSprite', 'value': 10349 },
                  { 'name': 'EdgeSprite', 'value': 3301 },
                  { 'name': 'NodeSprite', 'value': 19382 },
                  {
                    'name': 'render',
                    'children': [
                      { 'name': 'ArrowType', 'value': 698 },
                      { 'name': 'EdgeRenderer', 'value': 5569 },
                      { 'name': 'IRenderer', 'value': 353 },
                      { 'name': 'ShapeRenderer', 'value': 2247 }
                    ]
                  },
                  { 'name': 'ScaleBinding', 'value': 11275 },
                  { 'name': 'Tree', 'value': 7147 },
                  { 'name': 'TreeBuilder', 'value': 9930 }
                ]
              },
              {
                'name': 'events',
                'children': [
                  { 'name': 'DataEvent', 'value': 2313 },
                  { 'name': 'SelectionEvent', 'value': 1880 },
                  { 'name': 'TooltipEvent', 'value': 1701 },
                  { 'name': 'VisualizationEvent', 'value': 1117 }
                ]
              },
              {
                'name': 'legend',
                'children': [
                  { 'name': 'Legend', 'value': 20859 },
                  { 'name': 'LegendItem', 'value': 4614 },
                  { 'name': 'LegendRange', 'value': 10530 }
                ]
              },
              {
                'name': 'operator',
                'children': [
                  {
                    'name': 'distortion',
                    'children': [
                      { 'name': 'BifocalDistortion', 'value': 4461 },
                      { 'name': 'Distortion', 'value': 6314 },
                      { 'name': 'FisheyeDistortion', 'value': 3444 }
                    ]
                  },
                  {
                    'name': 'encoder',
                    'children': [
                      { 'name': 'ColorEncoder', 'value': 3179 },
                      { 'name': 'Encoder', 'value': 4060 },
                      { 'name': 'PropertyEncoder', 'value': 4138 },
                      { 'name': 'ShapeEncoder', 'value': 1690 },
                      { 'name': 'SizeEncoder', 'value': 1830 }
                    ]
                  },
                  {
                    'name': 'filter',
                    'children': [
                      { 'name': 'FisheyeTreeFilter', 'value': 5219 },
                      { 'name': 'GraphDistanceFilter', 'value': 3165 },
                      { 'name': 'VisibilityFilter', 'value': 3509 }
                    ]
                  },
                  { 'name': 'IOperator', 'value': 1286 },
                  {
                    'name': 'label',
                    'children': [
                      { 'name': 'Labeler', 'value': 9956 },
                      { 'name': 'RadialLabeler', 'value': 3899 },
                      { 'name': 'StackedAreaLabeler', 'value': 3202 }
                    ]
                  },
                  {
                    'name': 'layout',
                    'children': [
                      { 'name': 'AxisLayout', 'value': 6725 },
                      { 'name': 'BundledEdgeRouter', 'value': 3727 },
                      { 'name': 'CircleLayout', 'value': 9317 },
                      { 'name': 'CirclePackingLayout', 'value': 12003 },
                      { 'name': 'DendrogramLayout', 'value': 4853 },
                      { 'name': 'ForceDirectedLayout', 'value': 8411 },
                      { 'name': 'IcicleTreeLayout', 'value': 4864 },
                      { 'name': 'IndentedTreeLayout', 'value': 3174 },
                      { 'name': 'Layout', 'value': 7881 },
                      { 'name': 'NodeLinkTreeLayout', 'value': 12870 },
                      { 'name': 'PieLayout', 'value': 2728 },
                      { 'name': 'RadialTreeLayout', 'value': 12348 },
                      { 'name': 'RandomLayout', 'value': 870 },
                      { 'name': 'StackedAreaLayout', 'value': 9121 },
                      { 'name': 'TreeMapLayout', 'value': 9191 }
                    ]
                  },
                  { 'name': 'Operator', 'value': 2490 },
                  { 'name': 'OperatorList', 'value': 5248 },
                  { 'name': 'OperatorSequence', 'value': 4190 },
                  { 'name': 'OperatorSwitch', 'value': 2581 },
                  { 'name': 'SortOperator', 'value': 2023 }
                ]
              },
              { 'name': 'Visualization', 'value': 16540 }
            ]
          }
        ]
      }

      // Specify the chart’s dimensions.
      const size = 300
      const width = size
      const height = size

      // Create the opacity scale.
      const opacity = d3.scaleLinear([0, 5], [0, 1])

      // Compute the layout.
      const newData = d3.hierarchy(data).sum(d => d.value).sort((a, b) => b.value - a.value)
      console.log('■newData：', newData)
      const root = d3.pack().size([width, height]).padding(10)(newData)

      // Create the SVG container.
      const svg = d3.create('svg')
        .attr('viewBox', `-${width / 2} -${height / 2} ${width} ${height}`)
        .attr('width', width)
        .attr('height', height)
        .attr('style', `display: block;`)

      // Append the nodes.
      const node = svg.append('g')
        .selectAll('circle')
        .data(root.descendants().slice(1))
        .join('circle')
        .attr('fill', d => d.children ? `rgba(219, 219, 219, ${opacity(d.depth)})` : `rgba(219, 219, 219, ${opacity(5)})`)
        // .attr('pointer-events', d => !d.children ? 'none' : null)
        .attr('style', `cursor: pointer;`)
        .on('mouseover', function () { d3.select(this).attr('stroke', '#000') })
        .on('mouseout', function () { d3.select(this).attr('stroke', null) })
        .on('click', (event, d) => focus !== d && (zoom(event, d), event.stopPropagation()))
      // .on('click', (event, d) => console.log('■click：', event, d))

      // Append the text labels.
      const label = svg.append('g')
        .style('font', '10px sans-serif')
        .attr('pointer-events', 'none')
        .attr('text-anchor', 'middle')
        .selectAll('text')
        .data(root.descendants())
        .join('text')
        .style('fill-opacity', d => d.parent === root ? 1 : 0)
        .style('display', d => d.parent === root ? 'inline' : 'none')
        .text(d => d.data.name)

      // Create the zoom behavior and zoom immediately in to the initial focus node.
      svg.on('click', (event) => zoom(event, root))
      // svg.on('click', (event) => console.log('■click：', event, root))
      let focus = root
      let view
      zoomTo([focus.x, focus.y, focus.r * 2])

      function zoomTo(v) {
        const k = width / v[2]

        view = v

        label.attr('transform', d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`)
        node.attr('transform', d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`)
        node.attr('r', d => d.r * k)
      }

      function zoom(event, d) {
        const focus0 = focus

        focus = d

        const transition = svg.transition()
          .duration(event.altKey ? 7500 : 750)
          .tween('zoom', d => {
            const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2])
            return t => zoomTo(i(t))
          })

        label
          .filter(function (d) { return d.parent === focus || this.style.display === 'inline' })
          .transition(transition)
          .style('fill-opacity', d => d.parent === focus ? 1 : 0)
          .on('start', function (d) { if (d.parent === focus) this.style.display = 'inline' })
          .on('end', function (d) { if (d.parent !== focus) this.style.display = 'none' })
      }

      // Append the SVG element.
      container.append(svg.node())

    </script>
  </body>
</html>